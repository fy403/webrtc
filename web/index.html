<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Signal Control Client</title>
    <link href="style.css" rel="stylesheet">

    <script src="config.js"></script>
    <script src="rc_protocol_v2.js"></script>
    <script src="webrtc_optimizer.js"></script>
    <script src="video_rtc.js"></script>
    <script src="control_curves.js"></script>
    <script src="keyboard_controller.js"></script>
    <script src="virtual_joystick_controller.js"></script>
    <script src="xbox_controller.js"></script>
    <script src="controller_manager.js"></script>
    <script src="data_rtc.js"></script>
</head>

<body>
    <div class="container">
        <!-- 视频层 - 最高层 -->
        <div class="video-layer">
            <div class="card">
                <div class="video-with-overlay">
                    <!-- 左侧状态面板 -->
                    <div class="status-overlay left-overlay">
                        <div class="status-group">
                            <div class="status-item-inline">
                                <div class="hint">上行网速</div>
                                <div class="mono" id="txSpeed">0.00 Kbit/s</div>
                            </div>
                            <div class="status-item-inline">
                                <div class="hint">下行网速</div>
                                <div class="mono" id="rxSpeed">0.00 Kbit/s</div>
                            </div>
                            <div class="status-item-inline">
                                <div class="hint">CPU使用率</div>
                                <div class="mono" id="cpuUsage">0.00%</div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧状态面板 -->
                    <div class="status-overlay right-overlay">
                        <div class="status-group">
                            <div class="status-item-inline">
                                <div class="hint">4G信号强度</div>
                                <div class="mono" id="signalStrength">-- dBm</div>
                            </div>
                            <div class="status-item-inline">
                                <div class="hint">服务状态</div>
                                <div class="mono" id="serviceStatus">检查中...</div>
                            </div>
                            <div class="status-item-inline">
                                <div class="hint">4G网络状态</div>
                                <div class="mono" id="simStatus">UNKNOWN</div>
                            </div>
                        </div>
                    </div>

                    <!-- 速度显示面板 -->
                    <div class="status-overlay speed-overlay">
                        <div class="speed-display">
                            <div class="speed-value" id="speedValue">0</div>
                            <div class="speed-unit">%</div>
                        </div>
                    </div>

                    <!-- 底部状态面板 -->
                    <div class="status-overlay bottom-overlay">
                        <div class="status-indicators-container">
                            <!-- 控制器状态指示器 -->
                            <div class="controller-status">
                                <div class="status-icon" id="keyboardStatus" title="键盘">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <rect height="16" rx="2" width="20" x="2" y="4" />
                                        <line x1="6" x2="6" y1="8" y2="8" />
                                        <line x1="10" x2="10" y1="8" y2="8" />
                                        <line x1="14" x2="14" y1="8" y2="8" />
                                        <line x1="18" x2="18" y1="8" y2="8" />
                                        <line x1="6" x2="6" y1="12" y2="12" />
                                        <line x1="10" x2="10" y1="12" y2="12" />
                                        <line x1="14" x2="14" y1="12" y2="12" />
                                        <line x1="18" x2="18" y1="12" y2="12" />
                                    </svg>
                                </div>
                                <div class="status-icon" id="xboxStatus" title="手柄">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="8" />
                                        <circle cx="12" cy="12" r="3" />
                                        <circle cx="7" cy="8" r="1.5" />
                                        <circle cx="17" cy="8" r="1.5" />
                                        <circle cx="7" cy="16" r="1.5" />
                                        <circle cx="17" cy="16" r="1.5" />
                                    </svg>
                                </div>
                                <div class="status-icon" id="gyroStatus" title="陀螺仪">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="8" />
                                        <line x1="12" x2="12" y1="4" y2="8" />
                                        <line x1="12" x2="12" y1="16" y2="20" />
                                        <line x1="4" x2="8" y1="12" y2="12" />
                                        <line x1="16" x2="20" y1="12" y2="12" />
                                        <circle cx="12" cy="12" r="2" />
                                    </svg>
                                </div>
                            </div>
                            <!-- 媒体轨道状态指示器 -->
                            <div class="media-status">
                                <div class="status-icon" id="videoTrackStatus" title="视频轨道">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <rect height="16" rx="2" width="20" x="2" y="4" />
                                        <polygon points="10 8 16 12 10 16 10 8" />
                                    </svg>
                                </div>
                                <div class="status-icon" id="audioTrackStatus" title="音频轨道">
                                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                        <line x1="12" x2="12" y1="19" y2="23" />
                                        <line x1="8" x2="16" y1="23" y2="23" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="signal-indicator-container">
                            <!-- 4G信号强度指示器 -->
                            <div class="signal-indicator" id="signalIndicator">
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                                <div class="signal-bar"></div>
                            </div>
                            <div class="signal-info">
                                <span class="signal-text">质量:</span>
                                <span class="signal-quality" id="signalQuality">--</span>
                            </div>
                        </div>
                        <div class="last-update">
                            <div class="hint">最后更新: <span id="lastUpdate">--</span></div>
                        </div>
                        <div class="last-update">
                            <div class="hint">油门最大比例: <span id="throttleLimitIndicator">不限</span></div>
                        </div>
                    </div>

                    <div class="video-container">
                        <video autoplay id="remoteVideo" playsinline></video>

                        <div class="no-signal-overlay" id="noSignalOverlay">
                            <div class="no-signal-text">无信号</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 控制层 - 下层 -->
        <div class="control-layer">
            <div class="card">
                <div class="control-panel">
                    <div class="connection-info">
                        <div id="connStatus"><span class="status-dot dot-red"></span><span
                                class="mono">DISCONNECTED</span></div>
                        <div class="hint" style="visibility: hidden;">目标: <span class="mono"
                                id="endpointText">ws://fy403.cn:8766</span>
                        </div>
                    </div>

                    <div class="control-buttons">
                        <button class="btn" id="reconnectBtn">重新连接</button>
                        <button class="btn" id="stopAllBtn">STOP ALL (Space)</button>
                        <button class="btn" id="emgBtn">急停 T</button>
                        <button class="btn" id="configBtn" title="配置">⚙️</button>
                        <!--						<button id="throttleBtn" class="btn">档位调整 F</button>-->
                    </div>
                </div>

                <div class="channel-display">
                    <div class="hint">SBUS通道实时数值：</div>
                    <div class="channels-container" id="channelsContainer">
                        <!-- 16个通道柱状图 -->
                        <div class="channel-bar-wrapper" data-channel="1">
                            <div class="channel-label">CH1</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel1Fill"></div>
                            </div>
                            <div class="channel-value" id="channel1Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="2">
                            <div class="channel-label">CH2</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel2Fill"></div>
                            </div>
                            <div class="channel-value" id="channel2Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="3">
                            <div class="channel-label">CH3</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel3Fill"></div>
                            </div>
                            <div class="channel-value" id="channel3Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="4">
                            <div class="channel-label">CH4</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel4Fill"></div>
                            </div>
                            <div class="channel-value" id="channel4Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="5">
                            <div class="channel-label">CH5</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel5Fill"></div>
                            </div>
                            <div class="channel-value" id="channel5Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="6">
                            <div class="channel-label">CH6</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel6Fill"></div>
                            </div>
                            <div class="channel-value" id="channel6Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="7">
                            <div class="channel-label">CH7</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel7Fill"></div>
                            </div>
                            <div class="channel-value" id="channel7Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="8">
                            <div class="channel-label">CH8</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel8Fill"></div>
                            </div>
                            <div class="channel-value" id="channel8Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="9">
                            <div class="channel-label">CH9</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel9Fill"></div>
                            </div>
                            <div class="channel-value" id="channel9Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="10">
                            <div class="channel-label">CH10</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel10Fill"></div>
                            </div>
                            <div class="channel-value" id="channel10Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="11">
                            <div class="channel-label">CH11</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel11Fill"></div>
                            </div>
                            <div class="channel-value" id="channel11Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="12">
                            <div class="channel-label">CH12</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel12Fill"></div>
                            </div>
                            <div class="channel-value" id="channel12Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="13">
                            <div class="channel-label">CH13</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel13Fill"></div>
                            </div>
                            <div class="channel-value" id="channel13Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="14">
                            <div class="channel-label">CH14</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel14Fill"></div>
                            </div>
                            <div class="channel-value" id="channel14Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="15">
                            <div class="channel-label">CH15</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel15Fill"></div>
                            </div>
                            <div class="channel-value" id="channel15Value">0</div>
                        </div>
                        <div class="channel-bar-wrapper" data-channel="16">
                            <div class="channel-label">CH16</div>
                            <div class="channel-bar-bg">
                                <div class="channel-bar-fill" id="channel16Fill"></div>
                            </div>
                            <div class="channel-value" id="channel16Value">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!--			<div class="card">-->
            <!--				<div id="debugInfo" class="debug-info">-->
            <!--					<h3>Debug Information</h3>-->
            <!--					<div id="videoInfo"></div>-->
            <!--				</div>-->
            <!--			</div>-->
        </div>
        <div class="card connection-info-card">
            <div class="connection-panel video-connection">
                <div class="connection-header">
                    <div class="connection-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect height="16" rx="2" width="20" x="2" y="4" />
                            <polygon points="10 8 16 12 10 16 10 8" />
                        </svg>
                    </div>
                    <h3>Video Connection</h3>
                </div>
                <div class="connection-info">
                    <div class="info-row">
                        <span class="label">Local ID:</span>
                        <span class="value mono" id="localId">--</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Status:</span>
                        <span class="status-text" id="status">Not connected</span>
                    </div>
                    <div class="info-row connect-control">
                        <span class="badge">Remote ID:</span>
                        <input class="input mono input-compact" id="offerId" placeholder="remote ID"
                            value="" />
                        <button class="btn btn-compact" id="offerBtn">Connect</button>
                    </div>
                </div>
            </div>

            <div class="connection-panel data-connection">
                <div class="connection-header">
                    <div class="connection-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M4 4h16v16H4z" />
                            <path d="M8 8h8v8H8z" />
                        </svg>
                    </div>
                    <h3>Data Connection</h3>
                </div>
                <div class="connection-info">
                    <div class="info-row">
                        <span class="label">Local ID:</span>
                        <span class="value mono" id="dataLocalId">--</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Status:</span>
                        <span class="status-text" id="dataStatus">Not connected</span>
                    </div>
                    <div class="info-row connect-control">
                        <span class="badge">Remote ID:</span>
                        <input class="input mono input-compact" id="dataOfferId" placeholder="remote ID"
                            value="" />
                        <button class="btn btn-compact" id="dataOfferBtn">Connect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 视频配置面板 -->
        <div class="video-config-panel">
            <div class="config-header">
                <div class="config-title">视频配置</div>
                <button class="btn btn-apply" id="applyVideoConfig">应用配置</button>
            </div>
            <div class="config-row">
                <div class="config-group">
                    <label class="config-label">分辨率</label>
                    <select class="config-select" id="resolutionSelect">
                        <option value="640x480" selected>640x480</option>
                        <option value="1280x720">1280x720</option>
                        <option value="1920x1080">1920x1080</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="text" class="config-input" id="resolutionCustom" placeholder="如: 1280x720" disabled>
                </div>
                <div class="config-group">
                    <label class="config-label">帧率 (FPS)</label>
                    <select class="config-select" id="fpsSelect">
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="30" selected>30</option>
                        <option value="60">60</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="number" class="config-input" id="fpsCustom" placeholder="如: 30" disabled min="1"
                        max="120">
                </div>
            </div>
            <div class="config-row">
                <div class="config-group">
                    <label class="config-label">码率 (bps)</label>
                    <select class="config-select" id="bitrateSelect">
                        <option value="1000000">1 Mbps</option>
                        <option value="2000000">2 Mbps</option>
                        <option value="5000000">4 Mbps</option>
                        <option value="8000000"  selected>8 Mbps</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="number" class="config-input" id="bitrateCustom" placeholder="如: 2000000" disabled
                        min="100000">
                </div>
                <div class="config-group">
                    <label class="config-label">视频格式</label>
                    <select class="config-select" id="formatSelect">
                        <option value="mjpeg">MJPEG</option>
                        <option value="yuyv422" selected>YUYV422</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="text" class="config-input" id="formatCustom" placeholder="如: yuyv422" disabled>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // 设备检测并重定向逻辑
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // 页面加载完成后执行检查
        document.addEventListener('DOMContentLoaded', function () {
            // 如果当前不是mobile.html页面且检测到是移动设备，则跳转到mobile.html
            if (!window.location.pathname.includes('mobile.html') && isMobileDevice()) {
                window.location.href = 'mobile.html';
            }

            // 初始化配置按钮
            const configBtn = document.getElementById('configBtn');
            if (configBtn) {
                configBtn.addEventListener('click', function() {
                    window.open('config.html', 'config', 'width=900,height=700,scrollbars=yes,resizable=yes');
                });
            }
        });
    </script>
</body>

</html>