<!doctype html>
<html lang="zh-CN">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Signal Control Client - Mobile</title>
	<link rel="stylesheet" href="mobile.css">
	<script src="video_rtc.js"></script>
	<script src="sbus_encoder.js"></script>
	<script src="control_curves.js"></script>
	<script src="keyboard_controller.js"></script>
	<script src="virtual_joystick_controller.js"></script>
	<script src="xbox_controller.js"></script>
	<script src="controller_manager.js"></script>
	<script src="data_rtc.js"></script>
</head>

<body>
	<div class="mobile-container">
		<!-- 视频容器 -->
		<div class="video-section">
			<div class="video-wrapper">
				<div class="video-with-overlay">
					<!-- 虚拟手柄控制层 -->
					<div class="virtual-joystick-container" id="virtualJoystickContainer">
						<div class="joystick-base" id="joystickBase">
							<div class="joystick-handle" id="joystickHandle"></div>
							<div class="joystick-center"></div>
						</div>
					</div>
					
					<!-- 顶部其他按钮 -->
					<div class="control-overlay top-control-overlay">
						<div class="top-controls">
							<button id="reconnectBtnMobile" class="btn mobile-btn">重新连接</button>
							<button id="stopAllBtnMobile" class="btn mobile-btn">STOP ALL</button>
							<button id="emgBtnMobile" class="btn mobile-btn">急停</button>
<!--							<button id="throttleBtnMobile" class="btn mobile-btn">档位调整</button>-->
							<button id="fullscreenBtn" class="btn mobile-btn">全屏</button>
						</div>
					</div>
					
					<!-- 左侧状态面板 -->
					<div class="status-overlay left-overlay">
						<div class="status-group">
							<div class="status-item-inline">
								<div class="hint">上行网速</div>
								<div class="mono" id="txSpeed">0.00 KB/s</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">下行网速</div>
								<div class="mono" id="rxSpeed">0.00 KB/s</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">CPU使用率</div>
								<div class="mono" id="cpuUsage">0.00%</div>
							</div>
						</div>
					</div>
					
					<!-- 右侧状态面板 -->
					<div class="status-overlay right-overlay">
						<div class="status-group">
							<div class="status-item-inline">
								<div class="hint">4G信号强度</div>
								<div class="mono" id="signalStrength">-- dBm</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">服务状态</div>
								<div class="mono" id="serviceStatus">检查中...</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">4G网络状态</div>
								<div class="mono" id="simStatus">UNKNOWN</div>
							</div>
						</div>
					</div>
					
					<!-- 速度显示面板 -->
					<div class="status-overlay speed-overlay">
						<div class="speed-display">
							<div class="speed-value" id="speedValue">0</div>
							<div class="speed-unit">%</div>
						</div>
					</div>
					
					<!-- 底部状态面板 -->
					<div class="status-overlay bottom-overlay">
						<div class="signal-indicator-container">
							<!-- 4G信号强度指示器 -->
							<div class="signal-indicator" id="signalIndicator">
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
							</div>
							<div class="signal-info">
								<span class="signal-text">质量:</span>
								<span class="signal-quality" id="signalQuality">--</span>
							</div>
						</div>
						<div class="last-update">
							<div class="hint">最后更新: <span id="lastUpdate">--</span></div>
						</div>
					</div>
					
					<div class="video-container">
						<video id="remoteVideo" autoplay playsinline></video>
						<div id="noSignalOverlay" class="no-signal-overlay">
							<div class="no-signal-text">无信号</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 隐藏的控制层（保持原有功能但默认隐藏） -->
		<div class="control-layer" style="display: none;">
			<div class="card">
				<div class="control-panel">
					<div class="connection-info">
						<div id="connStatus"><span class="status-dot dot-red"></span><span
								class="mono">DISCONNECTED</span></div>
						<div class="hint" style="visibility: hidden;">目标: <span class="mono"
								id="endpointText">ws://fy403.cn:8766</span></div>
					</div>

					<div class="control-buttons">
						<button id="reconnectBtn" class="btn">重新连接</button>
						<button id="stopAllBtn" class="btn">STOP ALL (Space)</button>
						<button id="emgBtn" class="btn">急停 T</button>
<!--						<button id="throttleBtn" class="btn">档位调整 F</button>-->
					</div>
				</div>

				<div class="keyboard-controls">
					<div class="hint">按键映射：</div>
					<div class="kb">
						<div></div>
						<div id="keyW" class="key">W</div>
						<div></div>
						<div id="keyA" class="key">A</div>
						<div id="keyS" class="key">S</div>
						<div id="keyD" class="key">D</div>
					</div>
				</div>
			</div>
			
			<div class="card">
				<div id="debugInfo" class="debug-info">
					<h3>Debug Information</h3>
					<div id="videoInfo"></div>
				</div>
			</div>
		</div>
		
		<div class="hidden-elements" style="display: none;">
			<div>
				<h2>Local ID</h2>
				<p id="localId"></p>
			</div>
			<div id="status">Status: Not connected</div>
			<div>
				<h2>Local ID</h2>
				<p id="dataLocalId"></p>
			</div>
			<div id="dataStatus">Status: Not connected</div>
			
			<div class="video-controls">
				<span class="badge">Send offer to:</span>
				<input id="offerId" class="input mono" placeholder="remote ID" value="usbcam" />
				<button id="offerBtn" class="btn">Send</button>
			</div>
			<div class="video-controls">
				<span class="badge">Send offer to:</span>
				<input id="dataOfferId" class="input mono" placeholder="remote ID" value="dataTrack" />
				<button id="dataOfferBtn" class="btn">Send</button>
			</div>
		</div>
	</div>
	
	<script>
		// 设备检测并重定向逻辑
		function isMobileDevice() {
			return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
		}
		
		// 页面加载完成后执行检查
		document.addEventListener('DOMContentLoaded', function() {
			// 如果当前不是mobile.html页面且检测到是移动设备，则跳转到mobile.html
			if (!window.location.pathname.includes('mobile.html') && isMobileDevice()) {
				window.location.href = 'mobile.html';
			}
			// 如果是mobile.html页面但不是移动设备，则跳转回index.html
			else if (window.location.pathname.includes('mobile.html') && !isMobileDevice()) {
				window.location.href = 'index.html';
			}
			
			// 添加全屏功能
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const videoContainer = document.querySelector('.video-with-overlay');
			
			if (fullscreenBtn) {
				fullscreenBtn.addEventListener('click', toggleFullScreen);
			}
			
			function toggleFullScreen() {
				if (!document.fullscreenElement && 
					!document.webkitFullscreenElement && 
					!document.mozFullScreenElement &&
					!document.msFullscreenElement) {
					// 进入全屏
					if (videoContainer.requestFullscreen) {
						videoContainer.requestFullscreen();
					} else if (videoContainer.webkitRequestFullscreen) {
						videoContainer.webkitRequestFullscreen();
					} else if (videoContainer.mozRequestFullScreen) {
						videoContainer.mozRequestFullScreen();
					} else if (videoContainer.msRequestFullscreen) {
						videoContainer.msRequestFullscreen();
					}
				} else {
					// 退出全屏
					if (document.exitFullscreen) {
						document.exitFullscreen();
					} else if (document.webkitExitFullscreen) {
						document.webkitExitFullscreen();
					} else if (document.mozCancelFullScreen) {
						document.mozCancelFullScreen();
					} else if (document.msExitFullscreen) {
						document.msExitFullscreen();
					}
				}
			}
			
			// 监听全屏变化事件，更新按钮文本
			document.addEventListener('fullscreenchange', handleFullscreenChange);
			document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
			document.addEventListener('mozfullscreenchange', handleFullscreenChange);
			document.addEventListener('MSFullscreenChange', handleFullscreenChange);
			
			function handleFullscreenChange() {
				const topControlOverlay = document.querySelector('.top-control-overlay');
				const isFullscreen = document.fullscreenElement || 
					document.webkitFullscreenElement || 
					document.mozFullScreenElement ||
					document.msFullscreenElement;
				
				if (fullscreenBtn) {
					if (isFullscreen) {
						fullscreenBtn.textContent = '退出全屏';
					} else {
						fullscreenBtn.textContent = '全屏';
					}
				}
				
				// 确保全屏时顶部按钮可见
				if (topControlOverlay) {
					if (isFullscreen) {
						topControlOverlay.style.display = 'block';
						topControlOverlay.style.zIndex = '9999';
						topControlOverlay.style.visibility = 'visible';
						topControlOverlay.style.opacity = '1';
					} else {
						// 退出全屏时恢复默认样式
						topControlOverlay.style.display = '';
						topControlOverlay.style.zIndex = '';
						topControlOverlay.style.visibility = '';
						topControlOverlay.style.opacity = '';
					}
				}
			}
		});
	</script>
</body>

</html>