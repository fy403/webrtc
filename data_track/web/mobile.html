<!doctype html>
<html lang="zh-CN">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Signal Control Client - Mobile</title>
	<link rel="stylesheet" href="mobile.css">
	<script src="webrtc_optimizer.js"></script>
	<script src="video_rtc.js"></script>
	<script src="sbus_encoder.js"></script>
	<script src="control_curves.js"></script>
	<script src="keyboard_controller.js"></script>
	<script src="virtual_joystick_controller.js"></script>
	<script src="xbox_controller.js"></script>
	<script src="gyroscope_controller.js"></script>
	<script src="controller_manager.js"></script>
	<script src="data_rtc.js"></script>
	<script src="dual_joystick_init.js"></script>
</head>

<body>
	<div class="mobile-container">
		<!-- 视频容器 -->
		<div class="video-section">
			<div class="video-wrapper">
				<div class="video-with-overlay">
					<!-- 虚拟手柄控制层 - 左摇杆（前后） -->
					<div class="virtual-joystick-container left-joystick" id="leftJoystickContainer">
						<div class="joystick-base" id="leftJoystickBase">
							<div class="joystick-handle" id="leftJoystickHandle"></div>
							<div class="joystick-center"></div>
						</div>
					</div>

					<!-- 虚拟手柄控制层 - 右摇杆（左右） -->
					<div class="virtual-joystick-container right-joystick" id="rightJoystickContainer">
						<div class="joystick-base" id="rightJoystickBase">
							<div class="joystick-handle" id="rightJoystickHandle"></div>
							<div class="joystick-center"></div>
						</div>
					</div>

					<!-- 顶部其他按钮 -->
					<div class="control-overlay top-control-overlay">
						<div class="top-controls">
							<button id="reconnectBtnMobile" class="btn mobile-btn">重新连接</button>
							<button id="stopAllBtnMobile" class="btn mobile-btn">STOP ALL</button>
							<button id="emgBtnMobile" class="btn mobile-btn">急停</button>
							<button id="gyroToggleBtn" class="btn mobile-btn" style="display: none;">陀螺仪</button>
							<button id="gyroCalibrateBtn" class="btn mobile-btn" style="display: none;">校准</button>
							<!--							<button id="throttleBtnMobile" class="btn mobile-btn">档位调整</button>-->
							<button id="fullscreenBtn" class="btn mobile-btn">全屏</button>
						</div>
					</div>

					<!-- 左侧状态面板 -->
					<div class="status-overlay left-overlay">
						<div class="status-group">
							<div class="status-item-inline">
								<div class="hint">上行网速</div>
								<div class="mono" id="txSpeed">0.00 KBit/s</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">下行网速</div>
								<div class="mono" id="rxSpeed">0.00 KBit/s</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">CPU使用率</div>
								<div class="mono" id="cpuUsage">0.00%</div>
							</div>
						</div>
					</div>

					<!-- 右侧状态面板 -->
					<div class="status-overlay right-overlay">
						<div class="status-group">
							<div class="status-item-inline">
								<div class="hint">4G信号强度</div>
								<div class="mono" id="signalStrength">-- dBm</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">服务状态</div>
								<div class="mono" id="serviceStatus">检查中...</div>
							</div>
							<div class="status-item-inline">
								<div class="hint">4G网络状态</div>
								<div class="mono" id="simStatus">UNKNOWN</div>
							</div>
						</div>
					</div>

					<!-- 速度显示面板 -->
					<div class="status-overlay speed-overlay">
						<div class="speed-display">
							<div class="speed-value" id="speedValue">0</div>
							<div class="speed-unit">%</div>
						</div>
					</div>

					<!-- 底部状态面板 -->
					<div class="status-overlay bottom-overlay">
						<div class="status-indicators-container">
							<!-- 控制器状态指示器 -->
							<div class="controller-status">
								<div class="status-icon" id="keyboardStatus" title="键盘">
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<rect x="2" y="4" width="20" height="16" rx="2"/>
										<line x1="6" y1="8" x2="6" y2="8"/>
										<line x1="10" y1="8" x2="10" y2="8"/>
										<line x1="14" y1="8" x2="14" y2="8"/>
										<line x1="18" y1="8" x2="18" y2="8"/>
										<line x1="6" y1="12" x2="6" y2="12"/>
										<line x1="10" y1="12" x2="10" y2="12"/>
										<line x1="14" y1="12" x2="14" y2="12"/>
										<line x1="18" y1="12" x2="18" y2="12"/>
									</svg>
								</div>
								<div class="status-icon" id="xboxStatus" title="手柄">
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="12" cy="12" r="8"/>
										<circle cx="12" cy="12" r="3"/>
										<circle cx="7" cy="8" r="1.5"/>
										<circle cx="17" cy="8" r="1.5"/>
										<circle cx="7" cy="16" r="1.5"/>
										<circle cx="17" cy="16" r="1.5"/>
									</svg>
								</div>
								<div class="status-icon" id="gyroStatus" title="陀螺仪">
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="12" cy="12" r="8"/>
										<line x1="12" y1="4" x2="12" y2="8"/>
										<line x1="12" y1="16" x2="12" y2="20"/>
										<line x1="4" y1="12" x2="8" y2="12"/>
										<line x1="16" y1="12" x2="20" y2="12"/>
										<circle cx="12" cy="12" r="2"/>
									</svg>
								</div>
							</div>
							<!-- 媒体轨道状态指示器 -->
							<div class="media-status">
								<div class="status-icon" id="videoTrackStatus" title="视频轨道">
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<rect x="2" y="4" width="20" height="16" rx="2"/>
										<polygon points="10 8 16 12 10 16 10 8"/>
									</svg>
								</div>
								<div class="status-icon" id="audioTrackStatus" title="音频轨道">
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
										<path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
										<line x1="12" y1="19" x2="12" y2="23"/>
										<line x1="8" y1="23" x2="16" y2="23"/>
									</svg>
								</div>
							</div>
						</div>
						<div class="signal-indicator-container">
							<!-- 4G信号强度指示器 -->
							<div class="signal-indicator" id="signalIndicator">
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
								<div class="signal-bar"></div>
							</div>
							<div class="signal-info">
								<span class="signal-text">质量:</span>
								<span class="signal-quality" id="signalQuality">--</span>
							</div>
						</div>
						<div class="last-update">
							<div class="hint">最后更新: <span id="lastUpdate">--</span></div>
						</div>
					</div>

					<div class="video-container">
						<video id="remoteVideo" autoplay playsinline></video>
						<div id="noSignalOverlay" class="no-signal-overlay">
							<div class="no-signal-text">无信号</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 隐藏的控制层（保持原有功能但默认隐藏） -->
		<div class="control-layer" style="display: none;">
			<div class="card">
				<div class="control-panel">
					<div class="connection-info">
						<div id="connStatus"><span class="status-dot dot-red"></span><span
								class="mono">DISCONNECTED</span></div>
						<div class="hint" style="visibility: hidden;">目标: <span class="mono"
								id="endpointText">ws://fy403.cn:8766</span></div>
					</div>

					<div class="control-buttons">
						<button id="reconnectBtn" class="btn">重新连接</button>
						<button id="stopAllBtn" class="btn">STOP ALL (Space)</button>
						<button id="emgBtn" class="btn">急停 T</button>
						<!--						<button id="throttleBtn" class="btn">档位调整 F</button>-->
					</div>
				</div>

				<div class="keyboard-controls">
					<div class="hint">按键映射：</div>
					<div class="kb">
						<div></div>
						<div id="keyW" class="key">W</div>
						<div></div>
						<div id="keyA" class="key">A</div>
						<div id="keyS" class="key">S</div>
						<div id="keyD" class="key">D</div>
					</div>
				</div>
			</div>

			<div class="card">
				<div id="debugInfo" class="debug-info">
					<h3>Debug Information</h3>
					<div id="videoInfo"></div>
				</div>
			</div>
		</div>

		<div class="hidden-elements" style="display: none;">
			<div>
				<h2>Local ID</h2>
				<p id="localId"></p>
			</div>
			<div id="status">Status: Not connected</div>
			<div>
				<h2>Local ID</h2>
				<p id="dataLocalId"></p>
			</div>
			<div id="dataStatus">Status: Not connected</div>

			<div class="video-controls">
				<span class="badge">Send offer to:</span>
				<input id="offerId" class="input mono" placeholder="remote ID" value="cam_dYFh3H3kf" />
				<button id="offerBtn" class="btn">Send</button>
			</div>
			<div class="video-controls">
				<span class="badge">Send offer to:</span>
				<input id="dataOfferId" class="input mono" placeholder="remote ID" value="data_Dd8fgkoKo90" />
				<button id="dataOfferBtn" class="btn">Send</button>
			</div>
		</div>
	</div>

	<script>
		// 设备检测并重定向逻辑
		function isMobileDevice() {
			return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
		}

		// 页面加载完成后执行检查
		document.addEventListener('DOMContentLoaded', function () {
			// 如果当前不是mobile.html页面且检测到是移动设备，则跳转到mobile.html
			if (!window.location.pathname.includes('mobile.html') && isMobileDevice()) {
				window.location.href = 'mobile.html';
			}
			// 如果是mobile.html页面但不是移动设备，则跳转回index.html
			else if (window.location.pathname.includes('mobile.html') && !isMobileDevice()) {
				window.location.href = 'index.html';
			}

			// 添加全屏功能
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const videoContainer = document.querySelector('.video-with-overlay');

			if (fullscreenBtn) {
				fullscreenBtn.addEventListener('click', toggleFullScreen);
			}

			function toggleFullScreen() {
				if (!document.fullscreenElement &&
					!document.webkitFullscreenElement &&
					!document.mozFullScreenElement &&
					!document.msFullscreenElement) {
					// 进入全屏
					if (videoContainer.requestFullscreen) {
						videoContainer.requestFullscreen();
					} else if (videoContainer.webkitRequestFullscreen) {
						videoContainer.webkitRequestFullscreen();
					} else if (videoContainer.mozRequestFullScreen) {
						videoContainer.mozRequestFullScreen();
					} else if (videoContainer.msRequestFullscreen) {
						videoContainer.msRequestFullscreen();
					}
				} else {
					// 退出全屏
					if (document.exitFullscreen) {
						document.exitFullscreen();
					} else if (document.webkitExitFullscreen) {
						document.webkitExitFullscreen();
					} else if (document.mozCancelFullScreen) {
						document.mozCancelFullScreen();
					} else if (document.msExitFullscreen) {
						document.msExitFullscreen();
					}
				}
			}

			// 监听全屏变化事件，更新按钮文本
			document.addEventListener('fullscreenchange', handleFullscreenChange);
			document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
			document.addEventListener('mozfullscreenchange', handleFullscreenChange);
			document.addEventListener('MSFullscreenChange', handleFullscreenChange);

			function handleFullscreenChange() {
				const topControlOverlay = document.querySelector('.top-control-overlay');
				const isFullscreen = document.fullscreenElement ||
					document.webkitFullscreenElement ||
					document.mozFullScreenElement ||
					document.msFullscreenElement;

				if (fullscreenBtn) {
					if (isFullscreen) {
						fullscreenBtn.textContent = '退出全屏';
					} else {
						fullscreenBtn.textContent = '全屏';
					}
				}

				// 确保全屏时顶部按钮可见
				if (topControlOverlay) {
					if (isFullscreen) {
						topControlOverlay.style.display = 'block';
						topControlOverlay.style.zIndex = '9999';
						topControlOverlay.style.visibility = 'visible';
						topControlOverlay.style.opacity = '1';
					} else {
						// 退出全屏时恢复默认样式
						topControlOverlay.style.display = '';
						topControlOverlay.style.zIndex = '';
						topControlOverlay.style.visibility = '';
						topControlOverlay.style.opacity = '';
					}
				}
			}

			// 陀螺仪支持检测和初始化
			const gyroToggleBtn = document.getElementById('gyroToggleBtn');
			const gyroCalibrateBtn = document.getElementById('gyroCalibrateBtn');
			let gyroscopeController = null;
			let gyroEnabled = false;

			// 检测陀螺仪支持
			function checkGyroscopeSupport() {
				if (typeof GyroscopeController !== 'undefined' && GyroscopeController) {
					const testController = new GyroscopeController();
					if (testController.isSupported()) {
						if (gyroToggleBtn) {
							gyroToggleBtn.style.display = 'inline-block';
							// iOS需要权限，显示初始状态
							if (testController.requiresPermission()) {
								gyroToggleBtn.textContent = '陀螺仪(未授权)';
							} else {
								gyroToggleBtn.textContent = '陀螺仪关';
							}
						}
						if (gyroCalibrateBtn) {
							gyroCalibrateBtn.style.display = 'inline-block';
						}
						console.log('Gyroscope supported');
						return true;
					}
				}
				console.log('Gyroscope not supported');
				return false;
			}

			// 初始化陀螺仪控制器
			function initGyroscopeController() {
				if (typeof GyroscopeController === 'undefined') return null;

				const controller = new GyroscopeController({
					sensitivity: 0.5,  // 降低灵敏度
					deadzone: 8,      // 增加死区
					onChange: (state) => {
						console.log('Gyroscope onChange:', state);
						if (window.controllerManager) {
							window.controllerManager._handle('gyroscope', state);
						}
					}
				});
				return controller;
			}

			// 陀螺仪按钮点击处理
			if (gyroToggleBtn) {
				gyroToggleBtn.addEventListener('click', async function() {
					if (!gyroscopeController) {
						gyroscopeController = initGyroscopeController();
					}

					if (!gyroEnabled) {
						// 开启陀螺仪
						let granted = true;
						if (gyroscopeController.requiresPermission()) {
							console.log('Requesting gyroscope permission...');
							granted = await gyroscopeController.requestPermission();
							console.log('Permission granted:', granted);
						}

						if (granted) {
							// 先启动控制器（register会再次调用start，但此时权限已设置）
							gyroscopeController.start();

							// 注册到controllerManager
							if (window.controllerManager) {
								window.controllerManager.register('gyroscope', gyroscopeController, 6);
							}

							gyroEnabled = true;
							gyroToggleBtn.textContent = '陀螺仪开';
							gyroToggleBtn.style.background = '#10b981';
							gyroToggleBtn.style.color = '#fff';

							// 显示校准按钮
							if (gyroCalibrateBtn) {
								gyroCalibrateBtn.style.display = 'inline-block';
							}

							// 隐藏虚拟手柄以避免冲突
							const leftJoystickContainer = document.getElementById('leftJoystickContainer');
							const rightJoystickContainer = document.getElementById('rightJoystickContainer');
							if (leftJoystickContainer) {
								leftJoystickContainer.style.opacity = '0.3';
								leftJoystickContainer.style.pointerEvents = 'none';
							}
							if (rightJoystickContainer) {
								rightJoystickContainer.style.opacity = '0.3';
								rightJoystickContainer.style.pointerEvents = 'none';
							}

							console.log('Gyroscope enabled and registered');
						} else {
							alert('陀螺仪权限未授予');
							gyroToggleBtn.textContent = '陀螺仪(未授权)';
						}
					} else {
						// 关闭陀螺仪
						gyroscopeController.stop();
						gyroEnabled = false;
						gyroToggleBtn.textContent = '陀螺仪关';
						gyroToggleBtn.style.background = '';
						gyroToggleBtn.style.color = '';

						// 隐藏校准按钮
						if (gyroCalibrateBtn) {
							gyroCalibrateBtn.style.display = 'none';
						}

						// 恢复虚拟手柄
						const leftJoystickContainer = document.getElementById('leftJoystickContainer');
						const rightJoystickContainer = document.getElementById('rightJoystickContainer');
						if (leftJoystickContainer) {
							leftJoystickContainer.style.opacity = '';
							leftJoystickContainer.style.pointerEvents = '';
						}
						if (rightJoystickContainer) {
							rightJoystickContainer.style.opacity = '';
							rightJoystickContainer.style.pointerEvents = '';
						}

						console.log('Gyroscope disabled');
					}
				});

				// 校准按钮点击处理
				if (gyroCalibrateBtn) {
					gyroCalibrateBtn.addEventListener('click', function() {
						if (gyroscopeController && gyroEnabled) {
							// 获取当前传感器数据并校准
							const handleOrientation = (event) => {
								if (event.beta !== null && event.gamma !== null) {
									gyroscopeController.recalibrate(event.beta, event.gamma);
									window.removeEventListener('deviceorientation', handleOrientation);
									console.log('Gyroscope recalibrated to current position');
									// 给用户反馈
									gyroCalibrateBtn.textContent = '已校准';
									setTimeout(() => {
										gyroCalibrateBtn.textContent = '校准';
									}, 1000);
								}
							};

							// 添加一次性监听器获取当前值
							window.addEventListener('deviceorientation', handleOrientation);
						}
					});
				}
			}

			// 页面加载完成后检测陀螺仪支持
			checkGyroscopeSupport();
		});
	</script>
</body>

</html>